@using Newtonsoft.Json
@using System.Net
@model StockDataWebsite.Models.StockDataViewModel

@{
    // SEO-Enhanced Title & Description
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = $"Comprehensive Financial Data for {Model.CompanyName}";
    ViewData["Description"] = $"Access comprehensive {Model.DataType} financial data, including historical metrics and the latest stock price for {Model.CompanyName} ({Model.CompanySymbol}).";
    ViewData["Keywords"] = $"stock data, financial statements, {Model.CompanyName}, {Model.CompanySymbol}, annual reports, quarterly reports, historical metrics";
}

@functions {
    // Format financial element names for display
    public string FormatElementName(string elementName)
    {
        if (string.IsNullOrEmpty(elementName)) return elementName;
        if (elementName.ToUpperInvariant() == elementName) return elementName;
        return System.Text.RegularExpressions.Regex.Replace(elementName, "(?<!^)([A-Z])", " $1");
    }
    public string UrlEncode(string value)
    {
        return WebUtility.UrlEncode(value);
    }
}

@if (!string.IsNullOrEmpty(ViewData["Keywords"]?.ToString()))
{
    <meta name="keywords" content="@ViewData["Keywords"]" />
}

<!-- JSON-LD Structured Data for SEO -->
@{
    // Ensure company name and symbol are safe for JSON
    string safeCompanyName = Model.CompanyName?.Replace("\\", "\\\\").Replace("\"", "\\\"") ?? "";
    string safeCompanySymbol = Model.CompanySymbol?.Replace("\\", "\\\\").Replace("\"", "\\\"") ?? "";
    // Generate JSON string separately before using it inside @Html.Raw()
    string jsonLdData = $@"
    {{
      ""@context"": ""https://schema.org"",
      ""@type"": ""FinancialService"",
      ""name"": ""Alpha Stock Data"",
      ""description"": ""Testing JSON snippet for {safeCompanyName} ({safeCompanySymbol})."",
      ""url"": ""https://alphastockdata.com/StockData?companyName={UrlEncode(safeCompanyName)}"",
      ""logo"": ""https://alphastockdata.com/images/logo.png"",
      ""telephone"": ""N/A"",
      ""priceRange"": ""0"",
      ""address"": ""31 Dare Rd, Birmingham, B236PE, United Kingdom"",
      ""sameAs"": [
        ""https://x.com/AlphaStockData""
      ],
      ""serviceType"": ""StockData"",
      ""areaServed"": ""United States""
    }}";
}

<script type="application/ld+json">
    @Html.Raw(jsonLdData)
</script>

<style>
    .table-controls-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        gap: 1rem;
        flex-wrap: wrap;
    }

    #yearFilter {
        padding: 5px 10px;
        border-radius: 4px;
        border: 1px solid #ddd;
        width: 200px;
    }

    #addToWatchlistForm {
        margin: 0;
    }

    .fixed-scroll-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 8px;
        background: transparent;
        z-index: 1000;
        overflow-x: scroll;
    }

    .table-responsive {
        overflow-x: auto !important; /* Horizontal scrolling on phones */
        scrollbar-width: none;
        margin-bottom: 8px;
    }

    .fixed-scroll-container::-webkit-scrollbar {
        height: 8px;
        background: #f8f9fa;
    }

    .fixed-scroll-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }

    html {
        overflow-y: auto !important;
    }

    table th, table td {
        white-space: nowrap;
    }

    .element-name {
        position: relative;
    }
</style>

<h1 class="mb-3">
    Detailed Financial Data for <span class="text-primary">@Model.CompanyName</span>
    <small> (@Model.CompanySymbol)</small>
</h1>

@{
    // Compute the color for Daily Change.
    string dailyChangeColor = "black";
    if (Model.DailyChange.HasValue)
    {
        dailyChangeColor = Model.DailyChange.Value >= 0 ? "green" : "red";
    }
    // Compute Volume (value) based on StockPrice and Volume (shares).
    decimal volumeValue = 0;
    decimal displayVolume = 0;
    string volumeUnit = "";
    if (Model.Volume.HasValue && !string.IsNullOrEmpty(Model.StockPrice) && Model.StockPrice != "N/A")
    {
        var priceText = Model.StockPrice.Replace("$", "").Trim();
        decimal stockPriceNum = 0;
        if (decimal.TryParse(priceText, out stockPriceNum))
        {
            volumeValue = Model.Volume.Value * stockPriceNum;
        }
        displayVolume = volumeValue;
        if (volumeValue >= 1000000000)
        {
            displayVolume = volumeValue / 1000000000;
            volumeUnit = " Billion";
        }
        else if (volumeValue >= 1000000)
        {
            displayVolume = volumeValue / 1000000;
            volumeUnit = " Million";
        }
    }
}
<p>
    @if (!string.IsNullOrEmpty(Model.StockPrice))
    {
        <span>
            <strong>Stock Price:</strong> <strong>@Model.StockPrice</strong>
        </span>
    }
    @if (Model.DailyChange.HasValue)
    {
        <span style="margin-left:15px;">
            <strong>Daily Change:</strong>
            <span style="color:@dailyChangeColor;">
                <strong>@Model.DailyChange.Value.ToString("N2")%</strong>
            </span>
        </span>
    }
    @if (volumeValue > 0)
    {
        <span style="margin-left:15px;">
            <strong>Volume (value):</strong> <strong>$@(displayVolume.ToString("N2"))@volumeUnit</strong>
        </span>
    }
    @if (Model.Volume.HasValue)
    {
        <span style="margin-left:15px;">
            <strong>Volume (shares):</strong> <strong>@Model.Volume.Value.ToString("N0")</strong>
        </span>
    }
</p>
<p>
    Discover in-depth <strong>@Model.DataType</strong> financial reports, historical metrics,
    and the latest price for <strong>@Model.CompanyName</strong>
    (symbol: <strong>@Model.CompanySymbol</strong>). Scroll down to explore various statements,
    filter by year, and add this stock to your personal watchlist for quick access in the future.
</p>

<div class="alert alert-info" role="alert">
    <strong>Tip:</strong> You can click on an item name to view its historical graph.
</div>

<div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-3">
    <h2 class="mb-2 mb-md-0">Financial Results</h2>
    <div class="d-flex flex-wrap gap-2">
        <a href="/StockData/StockData?companyName=@UrlEncode(Model.CompanyName)&dataType=annual&yearFilter=@Model.SelectedYearFilter"
           class="btn btn-secondary report-type-link @(Model.DataType == "annual" ? "active" : "")"
           title="View Annual Data for @Model.CompanyName">
            Annual Data
        </a>
        <a href="@Url.Action("StockData", "StockData", new { companyName = Model.CompanyName, dataType = "quarterly", yearFilter = Model.SelectedYearFilter })"
           class="btn btn-secondary report-type-link @(Model.DataType == "quarterly" ? "active" : "")"
           title="View Quarterly Data for @Model.CompanyName">
            Quarterly Data
        </a>
        @if (Model.DataType == "enhanced")
        {
            <a href="@Url.Action("StockData", "StockData", new { companyName = Model.CompanyName, dataType = Model.BaseType, yearFilter = Model.SelectedYearFilter })"
               class="btn btn-secondary report-type-link @(Model.DataType=="enhanced" ? "active" : "")"
               title="View Basic Data for @Model.CompanyName">
                Basic Financial Data
            </a>
        }
        else
        {
            <a href="@Url.Action("StockData", "StockData", new { companyName = Model.CompanyName, dataType = "enhanced", baseType = Model.DataType, yearFilter = Model.SelectedYearFilter })"
               class="btn btn-secondary report-type-link @(Model.DataType=="enhanced" ? "active" : "")"
               title="View Enhanced Data for @Model.CompanyName">
                Enhanced Financial Data
            </a>
        }
    </div>
</div>
<div class="table-controls-container">
    @Html.DropDownListFor(m => m.SelectedYearFilter, Model.YearFilterOptions,
            new { @class = "form-select", id = "yearFilter" })
    <form id="addToWatchlistForm" action="/StockData/AddToWatchlist" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" name="stockName" value="@Model.CompanyName" />
        <input type="hidden" name="stockSymbol" value="@Model.CompanySymbol" />
        <button type="submit" class="btn btn-primary">Add to Watchlist</button>
    </form>
</div>

<div class="table-responsive" style="min-width: 100%;">
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                @if (Model.DataType == "enhanced")
                {
                    <th class="text-center">Element</th>
                }
                else
                {
                    <th class="text-center">Financial period:</th>
                }
                @if (Model.FinancialYears != null && Model.FinancialYears.Any())
                {
                    foreach (var period in Model.FinancialYears.AsEnumerable().Reverse())
                    {
                        <th class="text-center">@period.DisplayName.Replace("Report", "").Trim()</th>
                    }
                }
                else
                {
                    <th class="text-center">Period</th>
                }
            </tr>
        </thead>
        <tbody>
            @if (Model.Statements != null && Model.Statements.Any())
            {
                if (Model.DataType == "enhanced")
                {
                    foreach (var statement in Model.Statements)
                    {
                        foreach (var metric in statement.DisplayMetrics)
                        {
                            <tr>
                                <td class="align-middle text-nowrap">
                                    @{
                                        var formattedName = FormatElementName(metric.DisplayName ?? "").Replace("(null)", "").Trim();
                                        var isLongName = (formattedName.Length > 40);
                                        var displayName = isLongName ? formattedName.Substring(0, 40) + "..." : formattedName;
                                        var labels = Model.FinancialYears?.AsEnumerable()
                                        .Reverse()
                                        .Select(fy => fy.DisplayName.Replace("Report", "").Trim())
                                        .ToList() ?? new List<string>();
                                        var numericValues = metric.Values?.Select(v =>
                                        decimal.TryParse(v, out var n) ? n.ToString("N0") : "N/A"
                                        ).Reverse().ToList() ?? new List<string>();
                                    }
                                    @if (isLongName)
                                    {
                                        <span class="element-name text-primary"
                                              data-full-name="@formattedName"
                                              data-truncated-name="@displayName"
                                              data-expanded="false"
                                              data-metric="@formattedName"
                                              data-labels='@Html.Raw(JsonConvert.SerializeObject(labels))'
                                              data-values='@Html.Raw(JsonConvert.SerializeObject(numericValues))'
                                              style="cursor:pointer; text-decoration: underline;"
                                              title="Click to view graph">
                                            @displayName
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="element-name text-primary"
                                              data-metric="@formattedName"
                                              data-labels='@Html.Raw(JsonConvert.SerializeObject(labels))'
                                              data-values='@Html.Raw(JsonConvert.SerializeObject(numericValues))'
                                              style="cursor:pointer; text-decoration: underline;"
                                              title="Click to view historical data">
                                            @formattedName
                                        </span>
                                    }
                                </td>
                                @if (metric.Values != null && metric.Values.Any())
                                {
                                    foreach (var val in metric.Values.AsEnumerable().Reverse())
                                    {
                                        <td class="text-center">
                                            @if (string.IsNullOrEmpty(val) || val.Equals("N/A", StringComparison.OrdinalIgnoreCase))
                                            {
                                                @Html.Raw("<span style='color:#ccc;'>N/A</span>")
                                            }
                                            else
                                            {
                                                @val
                                            }
                                        </td>
                                    }
                                }
                                else
                                {
                                    <td colspan="@((Model.FinancialYears?.Count ?? 0))" class="text-center">
                                        N/A
                                    </td>
                                }
                            </tr>
                        }
                    }
                }
                else
                {
                    foreach (var statement in Model.Statements)
                    {
                        <tr class="table-primary">
                            <td colspan="@((Model.FinancialYears?.Count ?? 0) + 1)">
                                <strong>@statement.StatementType</strong>
                                @if (!string.IsNullOrEmpty(statement.ScalingLabel))
                                {
                                    <span class="badge bg-info text-dark">
                                        (@statement.ScalingLabel)
                                    </span>
                                }
                            </td>
                        </tr>
                        @if (statement.DisplayMetrics != null && statement.DisplayMetrics.Any())
                        {
                            foreach (var metric in statement.DisplayMetrics)
                            {
                                <tr>
                                    <td class="align-middle text-nowrap">
                                        @{
                                            var formattedName = FormatElementName(metric.DisplayName ?? "").Trim();
                                            var isLongName = (formattedName.Length > 40);
                                            var displayName = isLongName ? formattedName.Substring(0, 40) + "..." : formattedName;
                                        }
                                        @if (isLongName)
                                        {
                                            <span class="element-name text-primary"
                                                  data-full-name="@formattedName"
                                                  data-truncated-name="@displayName"
                                                  data-expanded="false"
                                                  data-scaling-label="@statement.ScalingLabel"
                                                  data-metric="@metric.DisplayName"
                                                  data-labels='@Html.Raw(JsonConvert.SerializeObject(Model.FinancialYears.Select(fy => fy.DisplayName.Replace("Report", "").Trim()).Reverse()))'
                                                  data-values='@Html.Raw(JsonConvert.SerializeObject(metric.Values.Select(v => v).Reverse()))'
                                                  style="cursor:pointer; text-decoration: underline;"
                                                  title="Click to view graph">
                                                @displayName
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="element-name text-primary"
                                                  data-metric="@metric.DisplayName"
                                                  data-scaling-label="@statement.ScalingLabel"
                                                  data-labels='@Html.Raw(JsonConvert.SerializeObject(Model.FinancialYears.Select(fy => fy.DisplayName.Replace("Report", "").Trim()).Reverse()))'
                                                  data-values='@Html.Raw(JsonConvert.SerializeObject(metric.Values.Select(v => v).Reverse()))'
                                                  style="cursor:pointer; text-decoration: underline;"
                                                  title="Click to view historical data">
                                                @formattedName
                                            </span>
                                        }
                                    </td>
                                    @if (metric.Values != null && metric.Values.Any())
                                    {
                                        foreach (var value in metric.Values.AsEnumerable().Reverse())
                                        {
                                            <td class="text-center">
                                                @if (string.IsNullOrEmpty(value) || value.Equals("N/A", StringComparison.OrdinalIgnoreCase))
                                                {
                                                    @Html.Raw("<span style='color:#ccc;'>N/A</span>")
                                                }
                                                else
                                                {
                                                    @value
                                                }
                                            </td>
                                        }
                                    }
                                    else
                                    {
                                        <td colspan="@((Model.FinancialYears?.Count ?? 1))" class="text-center">N/A</td>
                                    }
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="@((Model.FinancialYears?.Count ?? 1))" class="text-center text-muted">
                                    No financial metrics available for this statement.
                                </td>
                            </tr>
                        }
                    }
                }
            }
            else
            {
                <tr>
                    <td colspan="@((Model.FinancialYears?.Count ?? 1))">
                        No statements available.
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<div class="fixed-scroll-container">
    <div class="dummy-scroll-content" style="height: 1px;"></div>
</div>

<!-- Modal for Displaying the Chart -->
<div class="modal fade" id="graphModal" tabindex="-1" aria-labelledby="graphModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Historical Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="loadingIndicator" style="display:none;text-align:center;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading data...</p>
                </div>
                <div class="chart-container" style="position:relative;height:400px;width:100%;">
                    <canvas id="metricChart" style="display:none;"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Ensure jQuery is loaded (if not already in your layout) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Your custom chart logic -->
    <script src="~/js/chart.js"></script>

    <script>
        console.log("Custom script loaded");

        // Data variables from the model.
        const allPeriods = @Html.Raw(JsonConvert.SerializeObject(Model.FinancialYears));
        const uniqueYears = @Html.Raw(JsonConvert.SerializeObject(Model.UniqueYears));
        const dataType = '@Model.DataType';
        const baseType = '@Model.BaseType';
        let actualDataType = (dataType === "enhanced")
          ? ((baseType === "quarterly") ? "quarterly" : "annual")
          : dataType;
        const currentDisplayPeriods = [...allPeriods].reverse();
        // We'll store the chart instance in a global variable.
        let metricChart = null;

        // Delegated click handler for all .element-name elements.
        $(document).on('click', '.element-name', function () {
          console.log("Element clicked:", this);
          $('#loadingIndicator').css('display', 'block');
          $('#metricChart').css('display', 'none');

          // Retrieve and log raw data attributes.
          let rawLabels = $(this).attr('data-labels');
          let rawValues = $(this).attr('data-values');
          console.log("Raw data-labels:", rawLabels);
          console.log("Raw data-values:", rawValues);

          let labels, values;
          try {
            labels = JSON.parse(rawLabels).reverse();
            values = JSON.parse(rawValues).reverse();
            console.log("Parsed labels:", labels);
            console.log("Parsed values:", values);
          } catch (e) {
            console.error("Error parsing chart data:", e);
            $('#loadingIndicator').hide();
            return;
          }

          let scalingLabel = ($(this).attr('data-scaling-label') || '').trim();
          let metricName = ($(this).attr('data-metric') || '').trim();
          console.log("Raw scalingLabel:", scalingLabel, "Raw metricName:", metricName);

          // Clean helper function.
          const cleanString = (str) => (str || '').replace(/\(null\)/gi, '').trim();
          scalingLabel = cleanString(scalingLabel);
          metricName = cleanString(metricName);
          console.log("Cleaned scalingLabel:", scalingLabel, "Cleaned metricName:", metricName);

          // Parse numeric values.
          const parseNumeric = (val) => {
            if (typeof val !== 'string') return val;
            const num = parseFloat(val.replace(/,/g, ''));
            return isNaN(num) ? val : num;
          };
          let numericValues = values.map(v => parseNumeric(v));
          console.log("Numeric values:", numericValues);

          // Auto-calculate scaling if needed.
          if (!scalingLabel) {
            const validNumbers = numericValues.filter(v => typeof v === 'number');
            let scalingFactor = 0;
            if (validNumbers.length > 0) {
              const maxVal = Math.max(...validNumbers);
              if (maxVal >= 1e9) { scalingFactor = 9; scalingLabel = "in Billions $"; }
              else if (maxVal >= 1e6) { scalingFactor = 6; scalingLabel = "in Millions $"; }
              else if (maxVal >= 1e3) { scalingFactor = 3; scalingLabel = "in Thousands $"; }
              console.log("Calculated scalingFactor:", scalingFactor, "scalingLabel:", scalingLabel);
            }
            if (scalingFactor > 0) {
              numericValues = numericValues.map(v => (typeof v === 'number') ? v / Math.pow(10, scalingFactor) : v);
              console.log("Scaled numeric values:", numericValues);
            }
          }
          const finalValues = numericValues.map(v => (typeof v === 'number' ? v : null));
          console.log("Final values for chart:", finalValues);

          const chartTitle = scalingLabel ? `${metricName} (${scalingLabel})` : metricName;
          const yAxisTitle = scalingLabel ? `Amount (${scalingLabel})` : "Amount";

          // Prepare chart data and options.
          const chartData = {
            labels: labels,
            datasets: [{
              label: metricName,
              data: finalValues,
              borderColor: 'rgba(75,192,192,1)',
              backgroundColor: 'rgba(75,192,192,0.2)',
              fill: true,
              tension: 0.1
            }]
          };
          const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: { display: true, text: chartTitle || 'Historical Data' },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    let lbl = context.dataset.label || '';
                    if (lbl) lbl += ': ';
                    if (context.parsed.y !== null) {
                      lbl += context.parsed.y.toLocaleString();
                      if (scalingLabel) lbl += ` ${scalingLabel}`;
                    }
                    return lbl;
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: yAxisTitle },
                ticks: { callback: (v) => v.toLocaleString() },
                grid: { color: 'rgba(200,200,200,0.2)' }
              },
              x: {
                title: { display: true, text: 'Period' },
                grid: { color: 'rgba(200,200,200,0.2)' }
              }
            }
          };

          // Log before chart creation.
          console.log("Creating chart with data:", chartData);

          // Destroy previous chart instance if it exists and has a destroy function.
          if (window.metricChart && typeof window.metricChart.destroy === 'function') {
            window.metricChart.destroy();
          }

          // Create new chart.
          const ctx = document.getElementById('metricChart').getContext('2d');
          window.metricChart = new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: chartOptions
          });

          $('#loadingIndicator').hide();
          $('#metricChart').show();
          new bootstrap.Modal(document.getElementById('graphModal')).show();
          console.log("Chart rendered and modal shown.");
        });

        // Table header and year filter setup.
        document.addEventListener('DOMContentLoaded', function () {
          const headerRow = document.querySelector('thead tr');
          headerRow.innerHTML = `
            ${headerRow.children[0].outerHTML}
            ${currentDisplayPeriods.map(p => `<th class="text-center">${p.DisplayName.replace("Report", "").trim()}</th>`).join('')}
          `;
          const yearFilter = document.getElementById('yearFilter');
          yearFilter.value = (dataType === "quarterly") ? "3" : "all";
          handleYearFilterChange(yearFilter.value);
          yearFilter.addEventListener('change', function () {
            handleYearFilterChange(this.value);
          });
          window.addEventListener('popstate', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const yearFilterValue = urlParams.get('yearFilter') || ((dataType === "quarterly") ? "3" : "all");
            yearFilter.value = yearFilterValue;
            handleYearFilterChange(yearFilterValue);
          });
          const tableWrapper = document.querySelector('.table-responsive');
          const fixedScroll = document.querySelector('.fixed-scroll-container');
          const dummyContent = document.querySelector('.dummy-scroll-content');
          if (tableWrapper && fixedScroll) {
            const syncScrollWidth = () => { dummyContent.style.width = (tableWrapper.scrollWidth + 20) + 'px'; };
            syncScrollWidth();
            window.addEventListener('resize', syncScrollWidth);
            tableWrapper.addEventListener('scroll', () => { fixedScroll.scrollLeft = tableWrapper.scrollLeft; });
            fixedScroll.addEventListener('scroll', () => { tableWrapper.scrollLeft = fixedScroll.scrollLeft; });
          }
          console.log("Table header and year filter initialized.");
        });

        function handleYearFilterChange(selectedValue) {
          document.querySelectorAll('.report-type-link').forEach(link => {
            const url = new URL(link.href);
            url.searchParams.set('yearFilter', selectedValue);
            link.href = url.toString();
          });
          const newUrl = new URL(window.location);
          newUrl.searchParams.set('yearFilter', selectedValue);
          window.history.replaceState({}, "", newUrl);
          let numYears;
          switch (selectedValue) {
            case '5': numYears = 5; break;
            case '3': numYears = 3; break;
            case '1': numYears = 1; break;
            default: numYears = uniqueYears.length;
          }
          const yearsToShow = uniqueYears.slice(0, numYears);
          let periodsToShow;
          if (actualDataType === "annual") {
            periodsToShow = yearsToShow.map(year => year.toString());
          } else {
            periodsToShow = currentDisplayPeriods.filter(p => {
              const yr = parseInt(p.CompositeKey.split('-')[0]);
              return yearsToShow.includes(yr);
            }).map(p => p.DisplayName);
          }
          const headerRow = document.querySelector('thead tr');
          const headers = headerRow.querySelectorAll('th:not(:first-child)');
          headers.forEach((th, index) => {
            const period = currentDisplayPeriods[index];
            if (actualDataType === "annual") {
              th.style.display = periodsToShow.includes(period.DisplayName) ? '' : 'none';
            } else {
              const yr = parseInt(period.CompositeKey.split('-')[0]);
              th.style.display = yearsToShow.includes(yr) ? '' : 'none';
            }
          });
          const tableRows = document.querySelectorAll('tbody tr');
          tableRows.forEach(row => {
            const cells = row.querySelectorAll('td:not(:first-child)');
            cells.forEach((cell, index) => {
              const period = currentDisplayPeriods[index];
              if (actualDataType === "annual") {
                cell.style.display = periodsToShow.includes(period.DisplayName) ? '' : 'none';
              } else {
                const yr = parseInt(period.CompositeKey.split('-')[0]);
                cell.style.display = yearsToShow.includes(yr) ? '' : 'none';
              }
            });
          });
          const dummyContent = document.querySelector('.dummy-scroll-content');
          const tableWrapper = document.querySelector('.table-responsive');
          dummyContent.style.width = (tableWrapper.scrollWidth + 20) + 'px';
          console.log("Year filter changed to:", selectedValue);
        }

        // Cache the table HTML using a key based on company symbol and data type.
        (function () {
          const htmlCacheKey = 'financialTableHTML_' +
            encodeURIComponent('@Model.CompanySymbol') + '_' +
            encodeURIComponent(dataType);
          document.addEventListener('DOMContentLoaded', () => {
            let cachedHtml = localStorage.getItem(htmlCacheKey);
            if (cachedHtml) {
              console.log('HTML cache HIT for', htmlCacheKey);
              let tableContainer = document.querySelector('.table-responsive');
              if (tableContainer) {
                tableContainer.innerHTML = cachedHtml;
                console.log("Cached HTML inserted into table container.");
              }
            } else {
              console.log('HTML cache MISS for', htmlCacheKey);
            }
            setTimeout(() => {
              let tableContainer = document.querySelector('.table-responsive');
              if (tableContainer) {
                localStorage.setItem(htmlCacheKey, tableContainer.innerHTML);
                console.log('HTML cache updated for key:', htmlCacheKey);
              }
            }, 2000);
          });
        })();

        // Financial data caching.
        (function () {
          const cacheKey = 'financialData_' + '@Model.CompanySymbol';
          const cacheExpiryKey = cacheKey + '_expiry';
          const cacheDuration = 300000; // 5 minutes
          function fetchFinancialData() {
            let now = Date.now();
            let expiry = localStorage.getItem(cacheExpiryKey);
            if (expiry && now < parseInt(expiry)) {
              let cached = localStorage.getItem(cacheKey);
              if (cached) {
                try {
                  console.log("Data cache HIT for", cacheKey);
                  let data = JSON.parse(cached);
                  processFinancialData(data);
                  return;
                } catch (e) {
                  console.error('Error parsing cached data:', e);
                }
              }
            }
            console.log("Data cache MISS for", cacheKey);
            fetch('/api/financialdata?companySymbol=' + encodeURIComponent('@Model.CompanySymbol'))
              .then(response => {
                if (!response.ok) throw new Error('HTTP error, status = ' + response.status);
                return response.json();
              })
              .then(data => {
                localStorage.setItem(cacheKey, JSON.stringify(data));
                localStorage.setItem(cacheExpiryKey, now + cacheDuration);
                processFinancialData(data);
              })
              .catch(error => console.error('Error fetching financial data:', error));
          }
          function processFinancialData(data) {
            console.log('Processed financial data:', data);
          }
          document.addEventListener('DOMContentLoaded', fetchFinancialData);
        })();
    </script>
}








