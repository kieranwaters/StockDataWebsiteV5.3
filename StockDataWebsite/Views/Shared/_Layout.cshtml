@using Microsoft.AspNetCore.Http
@inject StockDataWebsite.Data.ApplicationDbContext _context
@inject IHttpContextAccessor _httpContextAccessor

<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5803746423727856" crossorigin="anonymous"></script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Dynamic Title & Description -->
    <title>@ViewData["Title"] - Alpha Stock Data</title>
    @if (ViewData["Description"] != null)
    {
        <meta name="description" content="@ViewData["Description"]" />
    }
    else
    {
        <meta name="description" content="Default description for Alpha Stock Data." />
    }

    <!-- Robots (index/follow) -->
    <meta name="robots" content="index, follow" />

    <!-- Open Graph Defaults (Override in specific pages if needed) -->
    <meta property="og:title" content="@((string)ViewData["Title"] ?? "Alpha Stock Data")" />
    <meta property="og:description" content="@((string)ViewData["Description"] ?? "Default description for Alpha Stock Data.")" />
    <meta property="og:url" content="https://alphastockdata.com/" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://alphastockdata.com/images/default-og-image.jpg" />

    <!-- Twitter Card Defaults -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="@((string)ViewData["Title"] ?? "Alpha Stock Data")" />
    <meta name="twitter:description" content="@((string)ViewData["Description"] ?? "Default description for Alpha Stock Data.")" />
    <meta name="twitter:image" content="https://alphastockdata.com/images/default-twitter-image.jpg" />

    <!-- Canonical URL Fallback -->
    <link rel="canonical" href="https://alphastockdata.com/" />

    <!-- Favicon (Using icon.jpg) -->
    <link rel="icon" type="image/jpeg" href="~/images/icon.jpg" />

    <!-- Bootstrap, Font Awesome, Bundled Site CSS -->
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
          integrity="sha512-pVn6SAHs/...=="
          crossorigin="anonymous"
          referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="~/css/site.bundle.min.css" asp-append-version="true" />

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TL41QQ3KL4"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ENjdO4Dr2bkBIFxQpeo...yourHashHere..."
            crossorigin="anonymous"></script>

    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-TL41QQ3KL4');
    </script>
</head>

@functions {
    public bool IsUserAdmin()
    {
        var username = _httpContextAccessor.HttpContext.Session.GetString("Username");
        if (string.IsNullOrEmpty(username)) return false;
        var user = _context.Users.FirstOrDefault(u => u.Username == username);
        if (user == null) return false;
        return user.Admin;
    }
}

@{
    // Determine the current controller and action to identify if on StockData page
    var currentController = ViewContext.RouteData.Values["controller"]?.ToString() ?? "";
    var currentAction = ViewContext.RouteData.Values["action"]?.ToString() ?? "";
    bool isStockDataPage = currentController.Equals("StockData", StringComparison.OrdinalIgnoreCase);

    // If not on the StockData page, pre-fill with 'companyName' from query string; otherwise, leave empty
    string defaultSearchValue = isStockDataPage ? "" : (_httpContextAccessor.HttpContext?.Request?.Query?["companyName"].ToString() ?? "");

    // If on the StockData page, get the current company name to exclude it from suggestions
    string currentCompanyName = isStockDataPage ? (_httpContextAccessor.HttpContext?.Request?.Query?["companyName"].ToString() ?? "") : "";
}

<body>
    <header>
        <nav class="navbar navbar-expand-sm navbar-toggleable-sm navbar-light bg-white border-bottom box-shadow mb-3">
            <div class="container-fluid">
                <a class="navbar-brand" asp-area="" asp-controller="Home" asp-action="Index">AlphaStockData</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                        data-bs-target=".navbar-collapse"
                        aria-controls="navbarSupportedContent"
                        aria-expanded="false"
                        aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="navbar-collapse collapse d-sm-inline-flex justify-content-between">
                    <ul class="navbar-nav flex-grow-1">
                        <li class="nav-item">
                            <a class="nav-link text-dark" asp-controller="Home" asp-action="Index">Home</a>
                        </li>
                        <li class="nav-item">
                            @if (IsUserAdmin())
                            {
                                <a class="nav-link" asp-controller="Scraper" asp-action="Index">Scraper (Admin)</a>
                            }
                        </li>
                    </ul>
                    <ul class="navbar-nav ms-auto">
                        <!-- Search Form in the Navbar -->
                        <li class="nav-item position-relative">
                            <form class="d-flex" asp-controller="StockData" asp-action="StockData" method="get" role="search" aria-label="Search for companies">
                                <input type="text" class="form-control me-2" id="NavbarCompanySearch" name="companyName" value="@defaultSearchValue" placeholder="Search for a company" aria-label="Search" autocomplete="off" />
                                <div id="navbarSuggestions" class="list-group position-absolute" style="top:100%;left:0;right:0;z-index:1000;"></div>
                                <button class="btn btn-outline-primary" type="submit">Search</button>
                            </form>
                        </li>
                        @if (_httpContextAccessor.HttpContext.Session.GetString("Username") != null)
                        {
                            <li class="nav-item">
                                <a class="nav-link text-dark" asp-controller="StockData" asp-action="Watchlist">
                                    Account (@_httpContextAccessor.HttpContext.Session.GetString("Username"))
                                </a>
                            </li>
                        }
                        else
                        {
                            <!-- Twitter Icon -->
                            <li class="nav-item">
                                <a class="nav-link text-dark"
                                   href="https://x.com/AlphaStockData"
                                   target="_blank"
                                   aria-label="Twitter">
                                    <i class="fab fa-twitter"></i>
                                </a>
                            </li>
                            <!-- Login Button -->
                            <li class="nav-item">
                                <a class="nav-link text-dark btn btn-outline-primary me-2"
                                   asp-controller="Account" asp-action="Login">Login</a>
                            </li>
                            <!-- Sign Up Button -->
                            <li class="nav-item">
                                <a class="nav-link btn btn-primary text-white"
                                   asp-controller="Account" asp-action="SignUp">Sign Up</a>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <div class="container">
        <main role="main" class="pb-3">
            @RenderBody()
        </main>
    </div>

    <footer class="border-top footer text-muted">
        <div class="container">
            &copy; 2024 - Alpha Stock Data -
            <a asp-area="" asp-controller="Home" asp-action="Index">Home</a>
        </div>
    </footer>

    <!-- Bundled local JavaScript files -->
    <script src="~/js/site.bundle.min.js" asp-append-version="true"></script>
    @await RenderSectionAsync("Scripts", required: false)

    <!-- Pass currentCompanyName to JavaScript -->
    <script>
        window.currentCompanyName = '@currentCompanyName';
    </script>
    <script>
        document.getElementById("NavbarCompanySearch").addEventListener("input", function () {
          const query = this.value.trim();
          const suggestionsDiv = document.getElementById("navbarSuggestions");

          // Clear suggestions if query is too short
          if (query.length < 2) {
            suggestionsDiv.innerHTML = "";
            return;
          }

          // Fetch suggestions from the API endpoint
          fetch("/api/companies/search?query=" + encodeURIComponent(query))
            .then(response => {
              if (!response.ok) {
                throw new Error("Network response was not ok " + response.statusText);
              }
              return response.json();
            })
            .then(data => {
              suggestionsDiv.innerHTML = "";
              if (data.length === 0) {
                suggestionsDiv.innerHTML = "<div class='list-group-item'>No results found</div>";
              } else {
                data.forEach(company => {
                  const a = document.createElement("a");
                  a.classList.add("list-group-item", "list-group-item-action");
                  a.textContent = `${company.companyName} (${company.companySymbol})`;
                  // When a suggestion is clicked, set the search box value and clear suggestions
                  a.addEventListener("click", function (e) {
                    e.preventDefault();
                    document.getElementById("NavbarCompanySearch").value = company.companyName;
                    suggestionsDiv.innerHTML = "";
                  });
                  suggestionsDiv.appendChild(a);
                });
              }
            })
            .catch(error => {
              console.error("Error fetching suggestions:", error);
            });
        });
    </script>
</body>
</html>
